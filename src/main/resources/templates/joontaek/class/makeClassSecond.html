<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{/layout/layout/layout}">
<head>
    <meta charset="UTF-8">
    <title>ê°•ì˜ ì»¤ë¦¬í˜ëŸ¼</title>
    <style>

        .lesson-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border: 1px solid #eee;
            margin: 5px 0;
            border-radius: 4px;
            gap: 10px; /* ìš”ì†Œë“¤ ì‚¬ì´ì˜ ê°„ê²© */
        }

        .video-badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 8px;
            background-color: #e3f2fd;
            color: #1976d2;
            border-radius: 4px;
            font-size: 0.9em;
            white-space: nowrap;
        }

        .lesson-title {
            flex-grow: 1;
            padding: 8px;
            cursor: pointer;
        }

        /* íŒŒì¼ ì—…ë¡œë“œ ê´€ë ¨ ìŠ¤íƒ€ì¼ ì¶”ê°€ */
        .file-preview {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            text-align: left;
        }

        .file-name {
            margin: 0;
            font-weight: bold;
            color: #333;
        }

        .file-size {
            margin: 5px 0;
            color: #666;
            font-size: 0.9em;
        }

        .delete-file-btn {
            background: #dc3545 !important;
            color: white !important;
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            margin-top: 10px;
        }

        .upload-btn {
            background: white !important;
            color: #333 !important;
            border: 1px solid #ddd !important;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
        }

        .upload-btn:hover {
            background: #f8f9fa !important;
        }

        button{
            background-color:#0092FF;
            color:white;
        }

        .content-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .section {
            background: #fff;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .section-title {
            width: 70%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .lesson-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border: 1px solid #eee;
            margin: 5px 0;
            border-radius: 4px;
        }

        .lesson-title {
            flex-grow: 1;
            padding: 8px;
            cursor: pointer;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
        }

        .modal-content {
            background: #fff;
            width: 80%;
            max-width: 500px;
            margin: 100px auto;
            padding: 20px;
            border-radius: 8px;
        }

        button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }

        .add-section-btn {
            background: #0092FF;
            color: white;
        }

        .delete-btn {
            background: #f44336;
            color: white;
        }
        /* ê¸°ì¡´ ìŠ¤íƒ€ì¼ì— ì¶”ê°€í•  ë‚´ìš© */
        .modal-content {
            background: #fff;
            width: 90%;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            border-radius: 8px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .close-btn {
            font-size: 24px;
            background: none;
            border: none;
            cursor: pointer;
            color: #666;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
        }

        .input-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .upload-section {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 4px;
            margin-bottom: 20px;
        }

        .upload-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .upload-btn {
            background: white !important;
            color: #333 !important;
            border: 1px solid #ddd !important;
        }

        .file-info {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 15px;
        }

        .upload-area {
            background: white;
            padding: 30px;
            text-align: center;
            border-radius: 4px;
        }

        .upload-desc {
            color: #666;
            margin-top: 5px;
        }

        .editor-section {
            margin-top: 20px;
        }

        .editor-section h3 {
            margin-bottom: 10px;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }

        .btn-cancel {
            background: white !important;
            color: #333 !important;
            border: 1px solid #ddd !important;
        }

        .btn-save {
            background: #4CAF50 !important;
            color: white !important;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .save-curriculum-btn {
            background: #4CAF50;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .save-curriculum-btn:hover {
            background: #45a049;
        }
    </style>
</head>
<body>

<div layout:fragment="content" class="content-container">
    <h2>ê°•ì˜ ì»¤ë¦¬í˜ëŸ¼</h2>
    <div id="sections-container"></div>
    <button class="add-section-btn" onclick="addSection()">ì„¹ì…˜ ì¶”ê°€</button>
    <button class="save-curriculum-btn" onclick="saveCurriculum()">ì»¤ë¦¬í˜ëŸ¼ ì €ì¥</button>


    <div id="lesson-modal" class="modal">
        <div class="modal-content">
            <h3>ìˆ˜ì—… ì œëª© ì…ë ¥</h3>
            <input type="text" id="lesson-title-input" placeholder="ìˆ˜ì—… ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”">
            <button onclick="saveLesson()">ì €ì¥</button>
            <button onclick="closeModal('lesson-modal')">ì·¨ì†Œ</button>
        </div>
    </div>


    <!-- content-modal ë¶€ë¶„ë§Œ ìˆ˜ì •í•˜ë©´ ë©ë‹ˆë‹¤ -->

    <div id="content-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ìˆ˜ì—… í¸ì§‘</h2>
                <button class="close-btn" onclick="closeModal('content-modal')">&times;</button>
            </div>

            <div class="modal-body">
                <div class="input-group">
                    <label>ìˆ˜ì—… ì œëª©</label>
                    <input type="text" id="content-title-input" placeholder="ìˆ˜ì—… ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”">  <!-- id ìˆ˜ì • -->
                </div>

                <div class="upload-section">
                    <div class="upload-header">
                        <span>ì˜ìƒ ì—…ë¡œë“œ</span>
                        <button class="upload-btn" onclick="triggerFileUpload()">ì‹ ê·œ ì—…ë¡œë“œ</button>
                        <!-- ìˆ¨ê²¨ì§„ íŒŒì¼ ì…ë ¥ í•„ë“œ ì¶”ê°€ -->
                        <input type="file" id="video-upload"
                               accept=".mp4,.mkv,.m4v,.mov"
                               style="display: none;"
                               onchange="handleFileSelect(this)">
                    </div>
                    <div class="file-info">
                        ìµœëŒ€ 5GB (.mp4, .mkv, .m4v, .mov ë§Œ ê°€ëŠ¥), ìµœì†Œ 720p ì´ìƒ
                    </div>
                    <div class="upload-area" id="upload-area">
                        <p id="upload-text">ì•„ì§ ì—…ë¡œë“œëœ ì˜ìƒì´ ì—†ì–´ìš”</p>
                        <p class="upload-desc">ìˆ˜ì—…ê³¼ ì—°ê´€ëœ ì°¸ê³  ì˜ìƒì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.</p>
                    </div>
                </div>

                <div class="editor-section">
                    <h3>ìˆ˜ì—… ë…¸íŠ¸ ì‘ì„±</h3>
                    <div id="editor">
                        <!-- ì—¬ê¸°ì— ì—ë””í„° APIê°€ ë“¤ì–´ê°ˆ ìë¦¬ -->
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeModal('content-modal')">ì·¨ì†Œ</button>
                <button class="btn-save" onclick="saveContent()">ì €ì¥</button>
            </div>
        </div>
    </div>
</div>

<div layout:fragment="scripts">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        let lessonVideos = new Map();
        let currentSection = null;
        let currentLessonItem = null;

        function addSection() {
            const sectionContainer = document.createElement('div');
            sectionContainer.classList.add('section');
            sectionContainer.innerHTML = `
        <div class="section-header">
            <input type="text" class="section-title" placeholder="ì„¹ì…˜ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”">
            <button class="delete-btn" onclick="this.closest('.section').remove()">ì„¹ì…˜ ì‚­ì œ</button>
        </div>
        <div class="lesson-list"></div>
        <button onclick="addLesson(this.closest('.section'))">ìˆ˜ì—… ì¶”ê°€</button>
    `;
            document.getElementById('sections-container').appendChild(sectionContainer);
        }

        function addLesson(section) {
            currentSection = section;
            document.getElementById('lesson-modal').style.display = 'block';
        }


        function saveLesson() {
            const title = document.getElementById('lesson-title-input').value;
            if (title.trim()) {
                const lessonItem = document.createElement('div');
                lessonItem.classList.add('lesson-item');
                // ê³ ìœ  ID ì¶”ê°€
                lessonItem.id = 'lesson-' + Date.now();
                lessonItem.innerHTML = `
            <div class="lesson-title" onclick="openContentModal(this.parentElement)">${title}</div>
            <button class="delete-btn" onclick="deleteLessonItem(this)">ì‚­ì œ</button>
        `;
                currentSection.querySelector('.lesson-list').appendChild(lessonItem);
                closeModal('lesson-modal');
                document.getElementById('lesson-title-input').value = '';
            }
        }

        function deleteLessonItem(button) {
            const lessonItem = button.closest('.lesson-item');
            lessonVideos.delete(lessonItem.id);  // ë¹„ë””ì˜¤ ë°ì´í„° ì‚­ì œ
            lessonItem.remove();
        }

        function openContentModal(lessonElement) {
            console.log("ëª¨ë‹¬ ì—´ë¦¼");

            currentLessonItem = lessonElement;
            const titleElement = lessonElement.querySelector('.lesson-title');
            const existingTitle = titleElement ? titleElement.textContent : '';

            const titleInput = document.getElementById('content-title-input');
            if (titleInput) {
                titleInput.value = existingTitle;
            }

            // í•´ë‹¹ ìˆ˜ì—…ì˜ ë¹„ë””ì˜¤ ìƒíƒœ ë³µì›
            const videoData = lessonVideos.get(currentLessonItem.id);
            const uploadArea = document.getElementById('upload-area');

            if (videoData) {
                uploadArea.innerHTML = `
            <div class="file-preview">
                <p class="file-name">${videoData.name}</p>
                <p class="file-size">${videoData.size}</p>
                <button class="delete-file-btn" onclick="removeFile()">ì‚­ì œ</button>
            </div>
        `;
            } else {
                uploadArea.innerHTML = `
            <p id="upload-text">ì•„ì§ ì—…ë¡œë“œëœ ì˜ìƒì´ ì—†ì–´ìš”</p>
            <p class="upload-desc">ìˆ˜ì—…ê³¼ ì—°ê´€ëœ ì°¸ê³  ì˜ìƒì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.</p>
        `;
            }

            document.getElementById('content-modal').style.display = 'block';
        }

        function saveContent() {
            console.log("ì €ì¥ ë²„íŠ¼ í´ë¦­ë¨");

            const titleInput = document.getElementById('content-title-input');

            if (!titleInput) {
                console.error('ì œëª© ì…ë ¥ í•„ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            const newTitle = titleInput.value;
            // lessonVideos Mapì—ì„œ ë¹„ë””ì˜¤ ì¡´ì¬ ì—¬ë¶€ í™•ì¸ìœ¼ë¡œ ë³€ê²½
            const hasVideo = lessonVideos.has(currentLessonItem.id);

            // ì œëª©ì´ ë¹„ì–´ìˆì§€ ì•Šì€ ê²½ìš°ì—ë§Œ ì—…ë°ì´íŠ¸
            if (currentLessonItem && newTitle.trim()) {
                // lesson-itemì˜ ë‚´ìš©ì„ ì—…ë°ì´íŠ¸
                currentLessonItem.innerHTML = `
            <div class="lesson-title" onclick="openContentModal(this.parentElement)">${newTitle}</div>
            ${hasVideo ? '<span class="video-badge">ğŸ“¹ ì˜ìƒ</span>' : ''}
            <button class="delete-btn" onclick="deleteLessonItem(this)">ì‚­ì œ</button>
        `;

                // ëª¨ë‹¬ ë‹«ê¸°
                closeModal('content-modal');

                // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
                titleInput.value = '';
            } else {
                alert('ìˆ˜ì—… ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            }
        }


        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';

            // video-upload input ì´ˆê¸°í™”
            document.getElementById('video-upload').value = '';

            // ëª¨ë‹¬ì´ ë‹«í ë•Œ í˜„ì¬ ì„ íƒëœ í•­ëª© ì´ˆê¸°í™”
            if (modalId === 'content-modal') {
                currentLessonItem = null;
            }
        }

        // ESC í‚¤ë¡œ ëª¨ë‹¬ ë‹«ê¸°
        window.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                document.querySelectorAll('.modal').forEach(modal => {
                    modal.style.display = 'none';
                });
                currentLessonItem = null;
            }
        });
        function triggerFileUpload() {
            document.getElementById('video-upload').click();
        }


        function handleFileSelect(input) {
            const file = input.files[0];
            if (!file) return;

            // í˜„ì¬ ì„ íƒëœ ìˆ˜ì—…ì´ ì—†ìœ¼ë©´ ë¦¬í„´
            if (!currentLessonItem) {
                alert('ìˆ˜ì—…ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.');
                input.value = '';
                return;
            }

            // íŒŒì¼ í¬ê¸° ì²´í¬ (5GB)
            const maxSize = 5 * 1024 * 1024 * 1024;
            if (file.size > maxSize) {
                alert('íŒŒì¼ í¬ê¸°ëŠ” 5GBë¥¼ ì´ˆê³¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                input.value = '';
                return;
            }

            // íŒŒì¼ í˜•ì‹ ì²´í¬
            const validTypes = ['.mp4', '.mkv', '.m4v', '.mov'];
            const fileExtension = file.name.toLowerCase().substring(file.name.lastIndexOf('.'));
            if (!validTypes.includes(fileExtension)) {
                alert('ì§€ì›í•˜ì§€ ì•ŠëŠ” íŒŒì¼ í˜•ì‹ì…ë‹ˆë‹¤. (.mp4, .mkv, .m4v, .mov íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥)');
                input.value = '';
                return;
            }

            // í˜„ì¬ ìˆ˜ì—…ì— ëŒ€í•œ ë¹„ë””ì˜¤ ë°ì´í„° ì €ì¥
            lessonVideos.set(currentLessonItem.id, {
                name: file.name,
                size: formatFileSize(file.size),
                file: file
            });

            // ì—…ë¡œë“œ ì˜ì—­ ì—…ë°ì´íŠ¸
            const uploadArea = document.getElementById('upload-area');
            uploadArea.innerHTML = `
        <div class="file-preview">
            <p class="file-name">${file.name}</p>
            <p class="file-size">${formatFileSize(file.size)}</p>
            <button class="delete-file-btn" onclick="removeFile()">ì‚­ì œ</button>
        </div>
    `;

            // íŒŒì¼ input ì´ˆê¸°í™” (ë‹¤ìŒ ì—…ë¡œë“œë¥¼ ìœ„í•´)
            input.value = '';
        }


        function removeFile() {
            // í˜„ì¬ ìˆ˜ì—…ì˜ ë¹„ë””ì˜¤ ë°ì´í„° ì‚­ì œ
            lessonVideos.delete(currentLessonItem.id);

            document.getElementById('video-upload').value = '';
            const uploadArea = document.getElementById('upload-area');
            uploadArea.innerHTML = `
        <p id="upload-text">ì•„ì§ ì—…ë¡œë“œëœ ì˜ìƒì´ ì—†ì–´ìš”</p>
        <p class="upload-desc">ìˆ˜ì—…ê³¼ ì—°ê´€ëœ ì°¸ê³  ì˜ìƒì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.</p>
    `;
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function saveCurriculum() {
            const formData = new FormData();

            // ì„¹ì…˜ê³¼ ìˆ˜ì—… ë°ì´í„° ìˆ˜ì§‘
            const sections = document.querySelectorAll('.section');
            const curriculumData = [];

            sections.forEach((section, sectionIndex) => {
                const sectionTitle = section.querySelector('.section-title').value;
                const lessons = section.querySelectorAll('.lesson-item');

                const sectionData = {
                    title: sectionTitle,
                    lessons: []
                };

                lessons.forEach((lesson, lessonIndex) => {
                    const lessonTitle = lesson.querySelector('.lesson-title').textContent;
                    const videoData = lessonVideos.get(lesson.id);

                    sectionData.lessons.push({
                        title: lessonTitle,
                        hasVideo: !!videoData
                    });

                    // ë¹„ë””ì˜¤ íŒŒì¼ì´ ìˆëŠ” ê²½ìš° FormDataì— ì¶”ê°€

                    if (videoData && videoData.file) {
                        formData.append('videos[]', videoData.file);  // videos[]ë¡œ ì „ì†¡
                    }

                });

                curriculumData.push(sectionData);
            });

            // curriculumDataë¥¼ JSON ë¬¸ìì—´ë¡œ ë³€í™˜í•˜ì—¬ ì¶”ê°€
            formData.append('curriculumData', JSON.stringify(curriculumData));


            console.log("ì „ì†¡í•  ë°ì´í„°:");
            for (let pair of formData.entries()) {
                console.log(pair[0], pair[1]);
            }


            // axios ìš”ì²­
            axios.post('/view/makeClass/third', formData, {
                headers: {
                    'Content-Type': 'multipart/form-data'
                }
            })
                .then(response => {
                    console.log("ì„œë²„ ì‘ë‹µ:", response.data);
                    if (response.data.success) {
                        alert('ì»¤ë¦¬í˜ëŸ¼ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
                        window.location.href = '/view/makeClass/thirdd';
                    } else {
                        throw new Error(response.data.message || 'ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    }
                })
                .catch(error => {
                    console.error('Error details:', error);
                    if (error.response) {
                        console.error('Server error:', error.response.data);
                        alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' +
                            (error.response.data.message || 'ì„œë²„ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'));
                    } else {
                        alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                    }
                });
        }







    </script>
</div>
</body>
</html>
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{/layout/layout/layout}">
<head>
    <meta charset="UTF-8">
    <title>장바구니</title>
    <link rel="stylesheet" href="/css/dongha/cart.css">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://js.bootpay.co.kr/bootpay-4.3.4.min.js" type="application/javascript"></script>
</head>
<body>

<div layout:fragment="content">
    <div class="cart-container">
        <h1>수강바구니</h1>

        <div class="cart-header">
            <div>
                <input type="checkbox" id="select-all" onclick="toggleAll(this)">
                <label for="select-all">전체선택 <span th:text="'(' + ${#lists.size(cart)} + '/' + ${#lists.size(cart)} + ')'"></span></label>
            </div>
            <button class="delete-btn" onclick="removeSelected()">선택삭제</button>
        </div>

        <div th:each="item : ${cart}" class="cart-item">
            <input type="checkbox" class="cart-checkbox" th:value="${item.classId}">
            <!--            <img th:src="@{${item.thumbnail}}" alt="강의 이미지">-->
            <div class="cart-info">
                <h3 th:text="${item.classTitle}"></h3>
                <p>강의 제공자: <span th:text="${item.userName}"></span></p>
                <p>수강 옵션: 무제한 수강</p>
            </div>
            <div class="cart-price">
                ₩<span th:text="${#numbers.formatInteger(item.cartPrice, 0, 'COMMA')}"></span>
            </div>
            <div class="cart-actions">
                <button class="delete-btn" th:onclick="|removeFromCart('${item.classId}')|">✖</button>
            </div>
        </div>

        <div class="cart-footer">
            <span class="total-price">총 결제 금액: ₩<span id="total-price">0</span></span>
            <button class="checkout-btn" onclick="startBootpay()">결제하기</button>
        </div>
    </div>
</div>

<div layout:fragment="scripts">
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            updateTotalPrice();

            document.querySelectorAll('.cart-checkbox').forEach(checkbox => {
                checkbox.addEventListener("change", updateTotalPrice);
            });

            document.getElementById("select-all").addEventListener("change", function () {
                document.querySelectorAll('.cart-checkbox').forEach(checkbox => {
                    checkbox.checked = this.checked;
                });
                updateTotalPrice();
            });
        });

        function updateTotalPrice() {
            let totalPrice = 0;
            document.querySelectorAll('.cart-checkbox:checked').forEach(checkbox => {
                const priceElement = checkbox.closest(".cart-item").querySelector(".cart-price span");
                totalPrice += parseInt(priceElement.textContent.replace(/[^0-9]/g, ''), 10);
            });
            document.getElementById("total-price").textContent = totalPrice.toLocaleString();
        }

        function removeFromCart(classId) {
            axios.delete(`/cart-api/remove?classId=${classId}`)
                .then(response => {
                    if (response.data.success) {
                        alert("장바구니에서 삭제되었습니다!");
                        location.reload();
                    } else {
                        alert("삭제 실패: " + response.data.message);
                    }
                })
                .catch(error => console.error("🚨 삭제 중 오류 발생:", error));
        }

        function removeSelected() {
            let selectedItems = document.querySelectorAll('.cart-checkbox:checked');
            if (selectedItems.length === 0) {
                alert("삭제할 항목을 선택하세요!");
                return;
            }

            let deleteRequests = [];
            selectedItems.forEach(item => {
                deleteRequests.push(axios.delete(`/cart-api/remove?classId=${item.value}`));
            });

            Promise.all(deleteRequests)
                .then(() => {
                    alert("선택한 항목이 삭제되었습니다!");
                    location.reload();
                })
                .catch(error => console.error("🚨 선택 삭제 중 오류 발생:", error));
        }

        function startBootpay() {
            let totalPrice = document.getElementById("total-price").textContent.replace(/[^0-9]/g, '');
            if (totalPrice == 0) {
                alert("결제할 항목이 없습니다.");
                return;
            }

            Bootpay.requestPayment({
                application_id: "679f11d7cc5274a3ac3fcc29",
                price: parseInt(totalPrice, 10),
                order_name: "수강 신청",
                pg: "KCP",
                method: "",
                order_id: "ORDER_" + new Date().getTime(),
                user: {
                    username: "홍길동",
                    email: "test@example.com"
                },
                items: [
                    {
                        id: "COURSE_123",
                        name: "강의 패키지",
                        qty: 1,
                        price: parseInt(totalPrice, 10)
                    }
                ],
                extra: {
                    sandbox: true,
                    methods: ["card", "phone", "kakaopay", "tosspay", "naverpay"]
                }
            }).then(response => {
                console.log("✅ 결제 성공:", response);
                alert("결제가 완료되었습니다!");

                // 🔥 서버에 결제 데이터 전송하여 DB 반영
                axios.post("/cart-api/payment", {
                    receipt_id: response.receipt_id,
                    order_id: response.order_id,
                    amount: response.price
                })
                    .then(() => {
                        alert("결제 정보가 저장되었습니다.");
                        location.href = "/payment-success";  // ✅ 결제 완료 페이지로 이동
                    })
                    .catch(error => {
                        console.error("🚨 결제 정보 저장 실패:", error);
                    });
            }).catch(error => {
                console.error("🚨 결제 실패:", error);
                alert("결제가 취소되었습니다.");
            });
        }
    </script>
</div>
</body>
</html>

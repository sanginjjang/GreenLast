<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{/layout/layout/layout}">
<head>
    <meta charset="UTF-8">
    <title>Admin Class</title>
</head>
<body>
<!-- aside (사용 버전) -->
<th:block layout:fragment="aside">
    <!--<aside> 태그는 *꼭* 남겨두시고 안에서 작업하시면 됩니다 // 절대 지우시면 안돼요-->
    <aside>
        <h1><a th:href="@{/admin/chartView}">통계조회</a></h1><br>
        <h1><a th:href="@{/admin/classView}">강의검토</a></h1><br>
        <h1><a th:href="@{/admin/userView}">사용자 목록</a></h1><br>
    </aside>
</th:block>

<!-- content -->
<div layout:fragment="content">
    <h1>강의 검토 페이지</h1>
    <table>
        <thead>
        <tr>
            <th>대표이미지</th>
            <th>강의명</th>
            <th>강사명</th>
            <th>요청일시</th>
            <th>상태</th>
        </tr>
        </thead>
    </table>
</div>
</body>

<!--이거밖에서 스크립트 작성하면 안돌아갑니다...-->
<div layout:fragment="scripts">
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            loadPendingClasses();
        });

        function loadPendingClasses() {
            axios.get('/admin-api/pending-classes')
                .then(response => {
                    const classes = response.data;
                    const tableBody = document.getElementById('classTableBody');
                    tableBody.innerHTML = '';

                    // `class_permit = 'n'`인 데이터만 표시
                    const pendingClasses = classes.filter(classItem => classItem.classPermit === 'n');

                    pendingClasses.forEach(classItem => {
                        const row = document.createElement('tr');

                        // 이미지 처리
                        const imgSrc = classItem.fileNo ? `/uploads/${classItem.fileNo}.jpg` : '/default-thumbnail.jpg';
                        const imgCell = `<td><img src="${imgSrc}" alt="썸네일" style="width: 100px; height: 60px;"></td>`;

                        // 요청일시 변환 (yyyy-MM-dd)
                        const requestDate = new Date(classItem.classCreateDate).toISOString().split('T')[0];

                        // 행 추가
                        row.innerHTML = `
                        ${imgCell}
                        <td><a href="/admin/classDetail?classId=${classItem.classId}">${classItem.classTitle}</a></td>
                        <td>${classItem.userId}</td>
                        <td>${requestDate}</td>
                        <td>
                            <button onclick="approveClass(${classItem.classId})">승인</button>
                            <button onclick="showRejectModal(${classItem.classId})">반려</button>
                        </td>
                    `;
                        tableBody.appendChild(row);
                    });
                })
                .catch(error => {
                    console.error("강의 목록 불러오기 오류:", error);
                });
        }

        function approveClass(classId) {
            axios.post('/admin-api/approve-class', { classId: classId })
                .then(response => {
                    alert(response.data.message);
                    loadPendingClasses();
                })
                .catch(error => {
                    console.error("승인 오류:", error);
                    alert("승인 처리 중 오류가 발생했습니다.");
                });
        }

        function showRejectModal(classId) {
            document.getElementById('rejectClassId').value = classId;
            document.getElementById('rejectModal').style.display = 'block';
        }

        function rejectClass() {
            let classId = document.getElementById('rejectClassId').value;
            let reason = document.getElementById('rejectReason').value;

            if (!reason.trim()) {
                alert("반려 사유를 입력하세요!");
                return;
            }

            axios.post('/admin-api/reject-class', {
                classId: classId,
                rejectMessage: reason
            })
                .then(response => {
                    alert(response.data.message);
                    loadPendingClasses();
                })
                .catch(error => {
                    console.error("반려 오류:", error);
                    alert("반려 처리 중 오류가 발생했습니다.");
                });
        }
    </script>
    <div id="rejectModal" style="display:none;">
        <input type="hidden" id="rejectClassId">
        <textarea id="rejectReason" placeholder="반려 사유를 입력하세요"></textarea>
        <button onclick="rejectClass()">반려하기</button>
        <button onclick="document.getElementById('rejectModal').style.display='none'">취소</button>
    </div>
</div>
</html>
